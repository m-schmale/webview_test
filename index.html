<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Service Worker Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .controls {
        margin-bottom: 20px;
      }
      button {
        margin: 5px;
        padding: 10px 15px;
        background-color: #007cba;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #005a85;
      }
      #feedback {
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      .log-line {
        margin: 2px 0;
        padding: 2px;
      }
      .log-line.success {
        color: #008000;
      }
      .log-line.error {
        color: #cc0000;
      }
      .log-line.warn {
        color: #ff8800;
      }
      .log-line.info {
        color: #000;
      }
    </style>
  </head>
  <body>
    <h1>Service Worker Test</h1>

    <div class="controls">
      <button id="btnRegister">Register SW</button>
      <button id="btnReload">Reload Page</button>
      <button id="btnUnregister">Unregister SW</button>
      <button id="btnState">Check SW State</button>
      <button id="btnIntercept">Test Intercept</button>
      <button id="btnCache">Test Cache</button>
      <button id="btnClearCaches">Clear Caches</button>
    </div>

    <div id="feedback"></div>

    <script>
      (function () {
        // Diagnostic fetch for sw.js
        (function diagnosticFetchSW() {
          var url = "./sw.js";
          fetch(url, { cache: "no-store" })
            .then(function (res) {
              var ct = res.headers.get("content-type");
              var status = res.status;
              return res.text().then(function (txt) {
                var preview = txt.slice(0, 100).replace(/\n/g, "\\n");
                log(
                  "Diagnostic: sw.js status=" +
                    status +
                    ", content-type=" +
                    ct +
                    ", first 100 bytes: " +
                    preview,
                  status === 200 && ct && ct.indexOf("javascript") !== -1
                    ? "success"
                    : "error"
                );
              });
            })
            .catch(function (e) {
              log(
                "Diagnostic: sw.js fetch error: " +
                  (e && e.message ? e.message : e),
                "error"
              );
            });
        })();
        var feedback = document.getElementById("feedback");
        function log(msg, level) {
          level = level || "info";
          var time = new Date().toISOString();
          var line = document.createElement("div");
          line.className = "log-line " + level;
          line.textContent = "[" + time + "] " + msg;
          feedback.appendChild(line);
          feedback.scrollTop = feedback.scrollHeight;
        }

        // Receive messages from the Service Worker (e.g., fetch intercept logs)
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker.addEventListener("message", function (event) {
            try {
              log("SW -> " + JSON.stringify(event.data), "info");
            } catch (e) {
              log("SW -> [unserializable message]", "info");
            }
          });
        } else {
          log("Service workers not supported in this environment", "error");
        }

        var btnRegister = document.getElementById("btnRegister");
        if (btnRegister) {
          btnRegister.addEventListener("click", function () {
            if (!("serviceWorker" in navigator)) return;
            log("Registering service worker…", "info");
            navigator.serviceWorker
              .register("./sw.js", { scope: "./" })
              .then(function (reg) {
                reg.addEventListener("updatefound", function () {
                  log("SW update found (installing)…", "info");
                  var installing = reg.installing;
                  if (installing) {
                    installing.addEventListener("statechange", function () {
                      log(
                        "SW state: " + installing.state,
                        installing.state === "activated" ? "success" : "info"
                      );
                    });
                  }
                });
                return navigator.serviceWorker.ready;
              })
              .then(function (ready) {
                log(
                  "Service worker ready and controlling: " +
                    !!(ready && ready.active),
                  "success"
                );
                if (!navigator.serviceWorker.controller) {
                  log("Reload page for SW to take control.", "warn");
                }
              })
              .catch(function (e) {
                log(
                  "Register error: " + (e && e.message ? e.message : e),
                  "error"
                );
              });
          });
        }

        var btnReload = document.getElementById("btnReload");
        if (btnReload) {
          btnReload.addEventListener("click", function () {
            log("Reloading page to allow SW to take control...", "info");
            window.location.reload();
          });
        }

        var btnUnregister = document.getElementById("btnUnregister");
        if (btnUnregister) {
          btnUnregister.addEventListener("click", function () {
            if (!("serviceWorker" in navigator)) return;
            navigator.serviceWorker
              .getRegistrations()
              .then(function (regs) {
                if (!regs || !regs.length) {
                  log("No SW registrations to unregister", "warn");
                  return [];
                }
                return Promise.all(
                  regs.map(function (r) {
                    return r.unregister();
                  })
                );
              })
              .then(function () {
                log(
                  "Unregistered all service workers for this scope",
                  "success"
                );
              })
              .catch(function (e) {
                log(
                  "Unregister error: " + (e && e.message ? e.message : e),
                  "error"
                );
              });
          });
        }

        var btnState = document.getElementById("btnState");
        if (btnState) {
          btnState.addEventListener("click", function () {
            if (!("serviceWorker" in navigator)) return;
            navigator.serviceWorker
              .getRegistration("./")
              .then(function (reg) {
                var state = {
                  hasController: !!navigator.serviceWorker.controller,
                  installing: !!(reg && reg.installing),
                  waiting: !!(reg && reg.waiting),
                  active: !!(reg && reg.active),
                  scope: reg ? reg.scope : null,
                };
                log("SW state: " + JSON.stringify(state), "info");
              })
              .catch(function (e) {
                log(
                  "State error: " + (e && e.message ? e.message : e),
                  "error"
                );
              });
          });
        }

        var btnIntercept = document.getElementById("btnIntercept");
        if (btnIntercept) {
          btnIntercept.addEventListener("click", function () {
            try {
              // Request that the SW intercepts (it will reply with synthetic JSON)
              var url = "./intercept-test?ts=" + Date.now();
              fetch(url, { cache: "no-store" })
                .then(function (res) {
                  return res.text().then(function (text) {
                    return { ok: res.ok, text: text };
                  });
                })
                .then(function (result) {
                  log(
                    "Intercept fetch response: " + result.text,
                    result.ok ? "success" : "warn"
                  );
                })
                .catch(function (e) {
                  log(
                    "Intercept fetch error: " +
                      (e && e.message ? e.message : e),
                    "error"
                  );
                });
            } catch (e) {
              log(
                "Intercept fetch error: " + (e && e.message ? e.message : e),
                "error"
              );
            }
          });
        }

        var btnCache = document.getElementById("btnCache");
        if (btnCache) {
          btnCache.addEventListener("click", function () {
            if (!("caches" in window)) {
              log("Cache API not available", "error");
              return;
            }
            var cacheName = "page-cache";
            var key = "./cache-test-" + Date.now();
            var val = "hello-from-page-" + Date.now();
            caches
              .open(cacheName)
              .then(function (c) {
                return c
                  .put(
                    key,
                    new Response(val, {
                      headers: { "Content-Type": "text/plain" },
                    })
                  )
                  .then(function () {
                    return c;
                  });
              })
              .then(function (c) {
                return c.match(key);
              })
              .then(function (match) {
                return match ? match.text() : null;
              })
              .then(function (result) {
                if (result === val) {
                  log(
                    "Cache API put/get OK: " + JSON.stringify(result),
                    "success"
                  );
                } else {
                  log("Cache API mismatch: " + JSON.stringify(result), "warn");
                }
              })
              .catch(function (e) {
                log(
                  "Cache API error: " + (e && e.message ? e.message : e),
                  "error"
                );
              });
          });
        }

        var btnClearCaches = document.getElementById("btnClearCaches");
        if (btnClearCaches) {
          btnClearCaches.addEventListener("click", function () {
            if (!("caches" in window)) {
              log("Cache API not available", "error");
              return;
            }
            caches
              .keys()
              .then(function (names) {
                return Promise.all(
                  names.map(function (n) {
                    return caches.delete(n);
                  })
                ).then(function () {
                  return names;
                });
              })
              .then(function (names) {
                log("All caches cleared: " + JSON.stringify(names), "success");
              })
              .catch(function (e) {
                log(
                  "Clear caches error: " + (e && e.message ? e.message : e),
                  "error"
                );
              });
          });
        }
      })();
    </script>
  </body>
</html>
